---
title: Node学习（一）- 异步编程的优势与难点
date: 2017-02-26 13:22:27
categories: 技术笔记
tags: Node
---

这个系列是阅读**朴灵**的[**《深入浅出Node.js》**][1]的摘要笔记。

---

异步编程的流程控制不那么符合线性思维

单线程模型+同步I/O -> CPU与I/O无法重叠进行，性能差 **=>** 方法一：使用多线程提升性能 -> 业务逻辑变复杂，同时引入了多线程调度上下文切换开销，锁与同步等问题； 方法二：通过C/C++调用操作系统底层接口，手工完成异步I/O -> 调试开发门槛高

<!--more-->

## 异步编程的优势与难点
### 优势
1. 基于事件驱动的非阻塞I/O模型，使得CPU与I/O不互相依赖等待，资源利用更好
2. 对于网络应用（分布式、云），并行使得单点之间的组织更有效
3. I/O密集型问题能手（计算密集型：可通过V8性能，C/C++扩展，合理调度进行优化）

### 难点
1. 异常处理
Node在处理异常上形成了一种约定：将异常作为回调函数的第一个实参传回，如果为空值，则表明异步调用没有抛出异常：

    ```javascript
    aysnc(function (err, results) {
        // TODO
    });
    ```

    当我们自行编写异步方法时，也要遵循如下原则：

    * 必须执行调用者传入的回调函数
    * 正确传递异常供调用者判断

    ```javascript
    var async = function(callback) {
        process.nextTick(function() {
            var results = something;
            if (error) {
                return callback(error);
            }
            callback(null, results);
        });
    };
    ```

2. 函数嵌套过深
    例如网页渲染要求数据/模板/资源文件缺一不可（虽然三者之间并不依赖）等场景都会出现函数嵌套过深导致没有利用到异步I/O的并行优势

3. 阻塞代码
    JavaScript中没有sleep()这样的沉睡功能，如何阻塞代码（最通常的写法是**空循环**，但这样会持续占用CPU进行判断，破坏事件循环的调度，与真正的线程沉睡相去甚远）。
    处理方式：统一规划业务逻辑后，调用setTimeout()效果更好。

4. 多线程编程
    Node运行在服务器上，如果是多核CPU，单个Node进程实质上并没有充分利用多核CPU的。
    浏览器提出了**Web Workers**将JavaScript执行与UI渲染分离，更好的利用多核CPU为大量计算服务。Node借鉴于此，**child_process**是其基础API，**cluster**模块是更深层次的应用。

5. 异步转同步
    目前Node中试图同步式编程并没有原声支持，需要借助库或编译等手段来实现。但对于异步调用，通过良好的流程控制，还是能够将逻辑梳理成顺序式的形式。

[1]: https://book.douban.com/subject/25768396/